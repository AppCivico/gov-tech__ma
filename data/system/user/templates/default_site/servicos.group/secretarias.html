{layout="default_site:site/_layout"}

{layout:set name="title"}Serviços{/layout:set}
{if segment_4 == "" OR segment_4 ~ "/^P\d+/" OR segment_4 == config:reserved_category_word}
    <main class="h-feed">
        <header class="h-feed__header">
            {layout:set name="canonical"}{site_url}/{segment_1}/{segment_2}/{segment_3}{/layout:set}
            {if !segment_3}
                {redirect="404"}
            {/if}

            {exp:query
                sql="SELECT site_label AS service_site_label, site_description AS service_site_description
                    FROM exp_sites
                    WHERE site_name ='{segment_3}'
                    LIMIT 1
                "
            }
                <h1 class="h-feed__p-name">
                    {service_site_label}
                </h1>
                {layout:set name="title"}{service_site_label}{/layout:set}

                {if service_site_description}
                    <p>{service_site_description}</p>
                {/if}

                {if no_results}
                    <h1 class="h-feed__p-name">
                        {segment_3}
                        {layout:set name="title"}{segment_3}{/layout:set}
                    </h1>
                {/if}
            {/exp:query}

            <ul class="tab-bar tab-bar--services">
                <li class="tab-bar__tab {if segment_5 != 'programas'}tab-bar__tab--current{/if}">
                    <a class="tab-bar__label" href="/{segment_1}/{segment_2}/{segment_3}">
                        Serviços
                    </a>
                </li>

                {exp:cat2:id category_url_title="programas" parse="inward" site="{segment_3}"}
                    <li class="tab-bar__tab {if segment_5 == 'programas'}tab-bar__tab--current{/if}">
                        <a class="tab-bar__label" href="/{segment_1}/{segment_2}/{segment_3}/{config:reserved_category_word}/programas">
                            Programas
                        </a>
                    </li>
                {/exp:cat2:id}
            </ul>
        </header>

        {if segment_5 == "programas"}
            {exp:channel:entries channel="service" site="{segment_3}" limit="10"
                category="{exp:cat2:id category_url_title='programas' site='{segment_3}'}" parse="inward"
                disable="category_fields|custom_fields|member_data" status="not closed"
                paginate="inline"
            }
                {if no_results}
                    <ul class="h-feed__list h-feed__list--services">
                        <li class="h-feed__h-entry h-feed__h-entry--services h-entry">
                            Nenhum programa encontrado
                        </li>
                    </ul>
                {/if}

                {if count == 1}
                    <ul class="h-feed__list h-feed__list--services">
                {/if}
                        <li id="entry-{entry_id}" class="h-feed__h-entry h-feed__h-entry--services h-entry">
                            <a
                                {if channel_short_name == "page" || page_uri}
                                    href="{page_uri}"
                                {if:else}
                                    href="/servicos/{url_title}"
                                {/if}
                                class="h-entry__u-url h-entry__u-url--services h-entry__p-name h-entry__p-name--services p-name"
                            >
                                {title}
                            </a>
                        </li>
                {if count == total_results}
                    </ul>

                    {tp-pagination}
                {/if}
            {/exp:channel:entries}
        {if:else}
            {exp:query
                sql="SELECT DISTINCT ecp.entry_id, ect.url_title, ect.title
                FROM exp_category_posts ecp
                JOIN exp_channel_titles ect ON ecp.entry_id = ect.entry_id
                JOIN exp_channels ec ON ect.channel_id = ec.channel_id
                JOIN exp_sites es ON es.site_id = ect.site_id
                WHERE ec.channel_name = 'service'
                AND es.site_name = '{segment_3}'
                AND ect.status NOT IN ('closed')
                AND ecp.entry_id NOT IN (
                    SELECT entry_id
                    FROM exp_category_posts ecp2
                    JOIN exp_categories ec3 ON ecp2.cat_id = ec3.cat_id
                    JOIN exp_sites es2 ON es2.site_id = ec3.site_id
                    WHERE ec3.cat_url_title = 'programas'
                    AND es2.site_name = '{segment_3}'
                )"
                parse="inward" paginate="inline" limit="10"
            }
                {if no_results}
                    <ul class="h-feed__list h-feed__list--services">
                        <li class="h-feed__h-entry h-feed__h-entry--services h-entry">
                            Nenhum serviço encontrado
                        </li>
                    </ul>
                {/if}

                {if count == 1}
                    <ul class="h-feed__list h-feed__list--services">
                {/if}
                        <li id="entry-{entry_id}" class="h-feed__h-entry h-feed__h-entry--services h-entry">
                            <a
                                href="/servicos/{url_title}"
                                class="h-entry__u-url h-entry__u-url--services h-entry__p-name h-entry__p-name--services p-name"
                            >
                                {title}
                            </a>
                        </li>
                {if count == total_results}
                    </ul>

                    {tp-pagination}
                {/if}
            {/exp:query}
        {/if}
    </main>
{/if}
